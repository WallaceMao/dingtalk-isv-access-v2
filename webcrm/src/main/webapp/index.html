<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>功倍CRM</title>
    <script src="./js/jquery-2.1.3.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script type="text/javascript" src="./js/jquery.bootpag.js"></script>
    <link rel="stylesheet" href="./css/normalize.css">
    <link rel="stylesheet" href="./css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="./css/bootstrap.min.css">
</head>
<body>
    <div class="row">
        <div class="col-md-12 text-right">
            <button id="logout" class="btn btn-default" type="button" onclick="logout()">注销</button>
        </div>
    </div>
    <div id="content">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>公司名称</th>
                    <th>创建时间</th>
                    <th>所在行业</th>
                    <th>公司人数</th>
                    <th>联系人userId</th>
                    <th>创建者名称</th>
                    <th>创建者是管理员</th>
                    <th>创建者是老板</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="data-content">
            </tbody>
        </table>
    </div>
    <div id="page-selection"></div>
    <script>
        var TOKEN_NAME = "WORKBEI_TOKEN";
        var LOGIN_PAGE = "./login.html";
        var URL_LIST_PAGE = "/crm/v3w/corp/list";
        var URL_CALL_CORP_ADMIN = "/crm/v3w/isv/callActivateAdmin";
        //  工具类
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        function combineParams(params){
            params = params || {};
            var arr = [];
            for(var key in params){
                if(params.hasOwnProperty(key)){
                    arr.push(encodeURIComponent(key) + "=" + encodeURIComponent(params[key]));
                }
            }
            return arr.join("&");
        }
        function checkAuth(){
            return localStorage.getItem(TOKEN_NAME);
        }
        // ajax方法
        function fetchPageData(event, num){
            var isInit = !event;
            var url = URL_LIST_PAGE;
            if(!isInit){
                url += "?" + combineParams({pageOffset: num - 1});
            }
            $.ajax({
                headers: {Authorization: checkAuth()},
                method: "GET",
                url: url
            }).done(function(json){
                console.log(json);
                renderPage(json.data);
                if(isInit){
                    renderPagination(json, fetchPageData);
                }
            });
        }
        function phoneCall(corpId) {
            var url = URL_CALL_CORP_ADMIN + "?" + combineParams({corpId: corpId});
            $.ajax({
                headers: {Authorization: checkAuth()},
                method: "POST",
                url: url
            }).done(function(result){
                alert(JSON.stringify(result));
            });
        }
        function logout(){
            localStorage.clear();
            window.location.href = LOGIN_PAGE;
        }
        // view视图渲染方法
        function renderPage(array){
            var str = "";
            array.forEach(function(line){
                str += "<tr>";
                str += "<td>" + line.corpName + "</td>";
                str += "<td>" + (line.gmtCreate ? new Date(line.gmtCreate): null) + "</td>";
                str += "<td>" + line.industry + "</td>";
                str += "<td>" + line.corpCount + "</td>";
                str += "<td>" + line.creatorUserId + "</td>";
                str += "<td>" + line.creatorName + "</td>";
                str += "<td>" + line.creatorIsAdmin + "</td>";
                str += "<td>" + line.creatorIsBoss + "</td>";
                str += "<td><button type=\"button\" class=\"btn btn-success\" onclick=\"phoneCall('" + line.corpId + "')\">打电话</button></td>";
                str += "</tr>";
            });
            $("#data-content").html(str);
        }
        function renderPagination(json, cb){
            $('#page-selection').bootpag({
                total: Math.ceil(json.total / json.pageSize),
                page: json.pageOffset + 1,
                maxVisible: 10
            }).on("page", cb);
        }
        // 初始化
        function init(){
            if(!checkAuth()){
                window.location.href = LOGIN_PAGE;
                return;
            }
            fetchPageData();
        }
        init();
    </script>
</body>
</html>