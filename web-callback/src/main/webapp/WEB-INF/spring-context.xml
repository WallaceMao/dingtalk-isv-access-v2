<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/util
       http://www.springframework.org/schema/util/spring-util.xsd">

    <bean id="propertyPlaceholderConfigurer"
          class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <property name="ignoreUnresolvablePlaceholders" value="true" />
        <property name="locations">
            <list>
                <value>file:${user.home}/dingtalk_rsq/ddauth-config.properties</value>
                <value>file:${user.home}/dingtalk_rsq/logback-config.properties</value>
            </list>
        </property>
    </bean>

    <util:map id="globalConfig" key-type="java.lang.String" value-type="java.lang.String">
        <entry key="dingtalkCorpCallback" value="${dingtalk.corp.callback}" />
    </util:map>

    <!--service层的服务beans-->
    <import resource="classpath:spring-service-dingmain.xml" />
    <import resource="classpath:spring-queue-amq.xml" />

    <!--eventBus-->
    <bean id="suiteCallbackBizService" class="com.rishiqing.dingtalk.web.dingcallback.service.impl.SuiteCallbackBizServiceImpl"/>
    <bean id="corpCallbackBizService" class="com.rishiqing.dingtalk.web.dingcallback.service.impl.CorpCallbackBizServiceImpl"/>
    <!--eventBus: corpSuite：企业授权开通的事件，只在传统回调的方式下使用，钉钉云环境下不使用该事件-->
    <bean id="asyncCorpSuiteAuthExecutorFactory"
          class="com.rishiqing.dingtalk.svc.event.AsyncCorpSuiteAuthEventExecutorFactory"/>
    <bean id="asyncCorpSuiteAuthExecutor" factory-bean="asyncCorpSuiteAuthExecutorFactory"
          factory-method="getExecutor"/>
    <bean id="asyncCorpSuiteAuthEventBus" class="com.google.common.eventbus.AsyncEventBus">
        <constructor-arg ref="asyncCorpSuiteAuthExecutor"/>
    </bean>
    <bean id="corpSuiteAuthEventListener" class="com.rishiqing.dingtalk.web.dingcallback.event.CorpSuiteAuthEventListener"/>
    <!--eventBus: corpSuite：企业授权变更的事件，只在传统回调的方式下使用，钉钉云环境下不使用该事件-->
    <bean id="asyncCorpSuiteChangeExecutorFactory"
          class="com.rishiqing.dingtalk.svc.event.AsyncCorpSuiteChangeEventExecutorFactory"/>
    <bean id="asyncCorpSuiteChangeExecutor" factory-bean="asyncCorpSuiteChangeExecutorFactory"
          factory-method="getExecutor"/>
    <bean id="asyncCorpSuiteChangeEventBus" class="com.google.common.eventbus.AsyncEventBus">
        <constructor-arg ref="asyncCorpSuiteChangeExecutor"/>
    </bean>
    <bean id="corpSuiteChangeEventListener" class="com.rishiqing.dingtalk.web.dingcallback.event.CorpSuiteChangeEventListener"/>

    <!--eventBus: 初始化-->
    <bean id="callbackListenerInitService" class="com.rishiqing.dingtalk.web.dingcallback.event.CallbackListenerInitService" init-method="register">
        <property name="eventListenerMap">
            <map>
                <entry key-ref="asyncCorpSuiteAuthEventBus" value-ref="corpSuiteAuthEventListener"/>
                <entry key-ref="asyncCorpSuiteChangeEventBus" value-ref="corpSuiteChangeEventListener"/>
            </map>
        </property>
    </bean>
</beans>